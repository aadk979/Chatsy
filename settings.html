<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings Page</title>
    <link rel="icon" type="image/jpeg" href="icon.jpeg">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-color: white;
            color: #ffffff;
        }

        .settings-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .settings-card {
            width: 400px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            background-color: #007bff;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .button-inline {
            display: inline-block;
            margin-left: 10px;
        }

        label {
            color: #ffffff;
        }

        .btn-outline-secondary {
            font-weight:800;
            background:#0000C8;
            color: white;
            border-color: #ffffff;
        }

        .btn-outline-secondary:hover {
            color: #000000;
            background-color: #ffffff;
        }

        .form-control {
            background-color:white;
            color: black;
        }

        .form-control-file {
            color: #ffffff;
        }
        input {
          background: ;
          color: black;
          border:none;
        }
        #xxx:disabled{
          background:#FF0000;
        }
    </style>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.2.0/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/__/firebase/8.10.1/firebase.js"></script>
  <script src="/__/firebase/init.js"></script>

  <script defer src="./init-firebase.js"></script>
  <script type="module">
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const _0x1a0534=_0x167f;(function(_0x174665,_0x23319a){const _0x25fd56=_0x167f,_0x2fd69e=_0x174665();while(!![]){try{const _0x78495e=parseInt(_0x25fd56(0x169))/(0x303+-0x1*-0x11f+-0x421)+-parseInt(_0x25fd56(0x17a))/(-0xd*-0x1df+-0xb0a+-0x3*0x46d)*(-parseInt(_0x25fd56(0x16e))/(-0x37f+0x4f*-0x42+-0x2fc*-0x8))+parseInt(_0x25fd56(0x17d))/(-0x1*0x2303+0xac1*-0x1+0x16e4*0x2)+-parseInt(_0x25fd56(0x170))/(0x1b7*-0x5+-0x107*0x1f+-0x2871*-0x1)+-parseInt(_0x25fd56(0x165))/(0x1*-0x1373+0xa*0x12d+0x7b7)*(parseInt(_0x25fd56(0x162))/(-0x1737+-0x4e6+0x1c24))+-parseInt(_0x25fd56(0x167))/(0x213d+-0x2*-0x66c+0x1*-0x2e0d)+parseInt(_0x25fd56(0x173))/(0xc93+-0x2436+0x3c*0x65)*(parseInt(_0x25fd56(0x168))/(-0x1b97*0x1+0x7*0x37d+0x336));if(_0x78495e===_0x23319a)break;else _0x2fd69e['push'](_0x2fd69e['shift']());}catch(_0x3e9ab3){_0x2fd69e['push'](_0x2fd69e['shift']());}}}(_0xcff4,0x139ef+0x3ae19+0x21*-0xbb9));function _0xcff4(){const _0xd639b6=['10pLJMrt','278000BBeWNC','App','G-6SP4HZTN','.com','13.appspot','33HgRtnR','13.firebas','931475cOiDuf','1816:web:e','AIzaSyDozo','5665131kxuUEd','9957815718','initialize','e3a3f5c855','efa83e2f76','eapp.com','U5wbIwL8g','722NXlyxS','-vine-4070','1:99578157','1024288xjwyZg','917FMQQcV','hpjwzD_W8p','invertible','17478txjtBS','OOGNNsp80f','3016744CnZmPT'];_0xcff4=function(){return _0xd639b6;};return _0xcff4();}const firebaseConfig={'apiKey':_0x1a0534(0x172)+_0x1a0534(0x163)+_0x1a0534(0x166)+_0x1a0534(0x179),'authDomain':_0x1a0534(0x164)+_0x1a0534(0x17b)+_0x1a0534(0x16f)+_0x1a0534(0x178),'projectId':_0x1a0534(0x164)+_0x1a0534(0x17b)+'13','storageBucket':_0x1a0534(0x164)+_0x1a0534(0x17b)+_0x1a0534(0x16d)+_0x1a0534(0x16c),'messagingSenderId':_0x1a0534(0x174)+'16','appId':_0x1a0534(0x17c)+_0x1a0534(0x171)+_0x1a0534(0x177)+_0x1a0534(0x176)+'d','measurementId':_0x1a0534(0x16b)+'QZ'};function _0x167f(_0x5e9c01,_0x1eec69){const _0x21b338=_0xcff4();return _0x167f=function(_0x17d807,_0x4bb513){_0x17d807=_0x17d807-(0x55a+-0x742+0x34a);let _0xcfd704=_0x21b338[_0x17d807];return _0xcfd704;},_0x167f(_0x5e9c01,_0x1eec69);}firebase[_0x1a0534(0x175)+_0x1a0534(0x16a)](firebaseConfig);
    
  </script>
  <script type="module" src="Mm.js"></script>
</head>
<body>

<div class="settings-container">
    <div class="settings-card">
        <h2 class="text-center"><strong>Settings</strong></h2>
        <span id="t" style="text-align: center; font-weight: 600;"></span>
      
        <form>

            <div class="form-group">
                <label for="displayName">Display Name</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="displayName" placeholder="Enter your display name">
                    <div class="input-group-append">
                        <button id="ppp" class="btn btn-outline-secondary" type="button">Change</button>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="changePassword">Change Password</label>
                <div class="input-group">
                    <input type="password" class="form-control" id="changePassword" placeholder="Enter new password">
                    <div class="input-group-append">
                        <button id="pp" class="btn btn-outline-secondary" type="button">Change</button>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="escapeLink">Escape Link</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="escapeLink" placeholder="Enter escape link">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" onclick="l()">Save</button>
                    </div>
                </div>
            </div>

            <div class="form-group" id = "3444">
                <label for="escapeLink">Use biometrics for locked chats</label>
                <div class="input-group">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" id="xxx">Setup biometrics</button>
                      <script>
                        const device = localStorage.getItem('device');
                        const bio = localStorage.getItem('bio');
                        if(device === 'false'){
                          document.getElementById("3444").remove();
                        }
                        if(bio === '200'){
                          document.getElementById("xxx").disabled = true;
                          document.getElementById("xxx").innerHTML = 'Biometrics already set up';
                        }
                        function generateRandomString(length) {
                            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                            let randomString = '';
                            for (let i = 0; i < length; i++) {
                                const randomIndex = Math.floor(Math.random() * charset.length);
                                randomString += charset.charAt(randomIndex);
                            }
                            return randomString;
                        }
                        const socket = io('https://main-testing-server.onrender.com');
                        const xxx = document.getElementById('xxx');
                        const fire = JSON.parse(localStorage.getItem('user_data_firebase'));
                        const user_email = fire.email;
                        const user_name = fire.displayName;
                        const uid = fire.uid;
                        xxx.onclick = ()=>{
                          registerUser(user_email , user_name);
                        }
                        async function registerUser(user_email , user_name) {
                            // Generate a random challenge
                            const challenge = generateRandomString(32);

                            try {
                                // Create a new credential
                                const credential = await navigator.credentials.create({
                                    publicKey: {
                                        challenge: Uint8Array.from(challenge, c => c.charCodeAt(0)),
                                        rp: { name: 'Chatsy' },
                                        user: { id: new Uint8Array(16), name: user_email, displayName: user_name},
                                        pubKeyCredParams: [{ type: 'public-key', alg: -7 }],
                                        timeout: 60000,
                                        attestation: 'direct'
                                    }
                                });

                                // Store credential ID and challenge in localStorage
                                localStorage.setItem('credentialId', btoa(String.fromCharCode.apply(null, new Uint8Array(credential.rawId))));
                                localStorage.setItem('challenge', challenge);

                                const return_code = generateRandomString(45);
                                const cid = btoa(String.fromCharCode.apply(null, new Uint8Array(credential.rawId)));

                                socket.emit('web-auth-setup' , ({uid: uid , credentialID: cid, challenge: challenge , return: return_code}));
                                socket.on(return_code , (data)=>{
                                  if(data === 200){
                                    alert('Biometrics setup successfully! 🥳');
                                    localStorage.setItem('bio' , '200');
                                    window.location.reload();
                                  }else if(data === 900){
                                    alert('Biometrics setup failed! 😥')
                                  }
                                })
                                // Display authentication section
                            } catch (error) {
                                console.error('Error registering userxxx:', error);
                                alert(error);
                            }
                        }

                        async function authenticateUser() {
                            // Retrieve stored data from localStorage
                            let credentialId;
                            let challenge;
                            const return_1 = generateRandomString(30); 
                            socket.emit('web-auth-auth' , ({uid: uid , return: return_1}));
                            socket.on(return_1, async (data) => {

                                    // Convert base64 strings to Uint8Array
                                    const challengeArray = new Uint8Array(atob(data.ch).split('').map(c => c.charCodeAt(0)));
                                    const credentialIdArray = new Uint8Array(atob(data.cid).split('').map(c => c.charCodeAt(0)));

                                    // Get authentication assertion
                                    const assertion = await navigator.credentials.get({
                                        publicKey: {
                                            challenge: challengeArray,
                                            rpId: window.location.hostname,
                                            allowCredentials: [{
                                                type: 'public-key',
                                                id: credentialIdArray,
                                                transports: ['internal']
                                            }],
                                            userVerification: 'required'
                                        }
                                    });

                                    if (assertion) {
                                        alert('Authentication successful!');
                                    } else {
                                        alert('Authentication failed!');
                                    }
                            });

                        }

                      </script>
                    </div>
                </div>
            </div>

            

            <div class="form-group">
                <label for="backgroundImage">Chat Background Image</label>
                <div class="input-group">
                    <input type="file" class="form-control-file" id="imageInput">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" onclick='saveImageToSessionStorage()'>Save</button>
                    </div>
                </div>
            </div>

        </form>
    </div>
</div>

<!-- Bootstrap JS and dependencies -->
    
  
  <script>
    
      const el = document.getElementById('escapeLink');
      function l(){
        localStorage.setItem('escl' , el.value);
        el.value = '';
        alert('Link saved succesfully. Note that the link you have provided will only be sued for this session.');
      }
    
      function saveImageToSessionStorage() {
          const imageInput = document.getElementById('imageInput');

          if (imageInput.files.length > 0) {
              const selectedImage = imageInput.files[0];

              const reader = new FileReader();

              reader.onload = function (event) {
                  localStorage.setItem('userImage', event.target.result);
                  alert('Background image set succesfully. It will be visible the next time you open a chat.');

                  // After 2 seconds, call the function to set the background
                  
              };

              reader.readAsDataURL(selectedImage);
          } else {
              alert('No image selected.');
          }
      }

      
  </script>
</body>
</html>
